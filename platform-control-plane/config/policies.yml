# Security and Operational Policies
# Defines guardrails, confirmations, and access controls

environments:
  dev:
    risk_level: low
    confirmations_required: false
    allowed_operations: all
    max_scale_size: 10
    deployment_restrictions: none
    
  staging:
    risk_level: medium
    confirmations_required: true
    confirmation_operations:
      - terminate
      - delete
      - failover
    allowed_operations: all
    max_scale_size: 20
    deployment_restrictions:
      blackout_windows: []
      approval_required: false
    
  prod:
    risk_level: high
    confirmations_required: true
    confirmation_operations:
      - scale
      - restart
      - terminate
      - delete
      - deploy
      - failover
      - update_firewall
      - isolate_endpoint
    allowed_operations:
      - read
      - status
      - logs
      - metrics
      - scale  # with confirmation
      - restart  # with confirmation
    max_scale_size: 50
    deployment_restrictions:
      blackout_windows:
        - start: "Friday 17:00"
          end: "Monday 09:00"
          timezone: "America/New_York"
      approval_required: true
      approvers:
        - platform-team
        - on-call-lead

operation_modes:
  read_only:
    description: "View-only access to all resources"
    allowed_verbs:
      - get
      - list
      - status
      - show
      - describe
    denied_verbs:
      - create
      - update
      - delete
      - scale
      - restart
      - deploy
      - terminate
      - isolate
  
  operator:
    description: "Day-to-day operational tasks"
    allowed_verbs:
      - get
      - list
      - status
      - show
      - describe
      - scale
      - restart
      - logs
      - metrics
      - acknowledge_alert
    denied_verbs:
      - delete
      - terminate
      - deploy
      - update_firewall
      - create_infrastructure
    requires_confirmation:
      - scale  # in prod
      - restart  # in prod
  
  admin:
    description: "Full control over all resources"
    allowed_verbs: all
    requires_confirmation:
      - delete
      - terminate
      - failover
      - update_firewall
      - isolate_endpoint  # always confirm
  
  emergency:
    description: "Emergency access - all operations allowed without confirmation"
    allowed_verbs: all
    requires_confirmation: []
    audit_level: detailed
    notification_channels:
      - security-team
      - platform-oncall
      - management

guardrails:
  # Scaling limits
  scaling:
    min_instances:
      default: 1
      prod: 2  # Never scale below 2 in prod
    max_instances:
      default: 20
      prod: 50
      dev: 10
    rate_limit: 5  # Max scale operations per hour
  
  # Deployment guardrails
  deployment:
    require_health_check: true
    rollback_on_failure: true
    canary_deployment:
      enabled: true
      initial_percentage: 10
      wait_time_minutes: 10
    max_parallel_deployments: 3
  
  # Security guardrails
  security:
    auto_isolate_severity:
      - ransomware
      - active_breach
      - data_exfiltration
    require_approval_for_release: true
    max_endpoints_isolate: 10  # Safety limit
    scan_before_release: true
  
  # Network guardrails
  network:
    firewall_changes:
      require_review: true
      test_connectivity: true
      rollback_window_minutes: 30
    vpn_operations:
      max_restart_per_hour: 2
      health_check_required: true
  
  # Database guardrails
  database:
    backup_before_operations:
      - resize
      - upgrade
      - failover
    maintenance_window_required:
      - upgrade
      - resize
    point_in_time_recovery: true

confirmations:
  # Confirmation token settings
  token:
    type: alphanumeric  # or 'word-based' for easier typing
    length: 6
    validity_seconds: 300
    display_format: "XXX-XXX"  # for readability
  
  # Messages for different operations
  messages:
    scale:
      template: "Scale {service} in {env} from {current} to {target} instances?"
      severity: medium
    terminate:
      template: "‚ö†Ô∏è TERMINATE {service} in {env}? This will destroy the resource!"
      severity: high
    deploy:
      template: "Deploy version {version} to {service} in {env}?"
      severity: medium
    isolate_endpoint:
      template: "üîí Isolate endpoint {hostname}? User access will be blocked!"
      severity: high
    failover:
      template: "Failover {database} from {current_primary} to {target}?"
      severity: high
    delete:
      template: "‚ö†Ô∏è DELETE {resource}? This action cannot be undone!"
      severity: critical

audit:
  # What to log
  log_level:
    read_operations: info
    write_operations: info
    failed_operations: warning
    security_operations: critical
  
  # Where to store logs
  storage:
    provider: aws
    service: s3
    bucket: expanseft-platform-audit
    prefix: "logs/{year}/{month}/{day}/"
    format: json
    encryption: AES256
  
  # Real-time streaming
  streaming:
    enabled: true
    provider: aws
    service: kinesis
    stream: platform-audit-stream
  
  # Retention
  retention:
    hot_days: 30  # Quick access
    warm_days: 90  # Slower access
    cold_days: 365  # Archive
    delete_after_days: 2555  # 7 years for compliance
  
  # Alert on suspicious activity
  alerts:
    multiple_failed_auth:
      threshold: 5
      window_minutes: 10
    unusual_operation_time:
      enabled: true
      business_hours: "09:00-18:00"
      timezone: "America/New_York"
    mass_operations:
      threshold: 10
      window_minutes: 5

notifications:
  # Slack integration
  slack:
    enabled: true
    webhook_url: "${SLACK_WEBHOOK_URL}"
    channels:
      default: "#platform-operations"
      security: "#security-alerts"
      critical: "#incidents"
    mentions:
      critical: "@channel"
      high: "@platform-oncall"
  
  # Email notifications
  email:
    enabled: true
    smtp_host: "smtp.expanseft.com"
    smtp_port: 587
    from_address: "platform-control@expanseft.com"
    recipients:
      default:
        - platform-team@expanseft.com
      security:
        - security@expanseft.com
      critical:
        - oncall@expanseft.com
        - management@expanseft.com
  
  # PagerDuty integration
  pagerduty:
    enabled: false
    api_key: "${PAGERDUTY_API_KEY}"
    service_id: "${PAGERDUTY_SERVICE_ID}"
    escalation_policy: "platform-oncall"

# Rate limiting per user/session
rate_limiting:
  default:
    requests_per_minute: 60
    requests_per_hour: 1000
  by_operation:
    scale: 5  # per hour
    deploy: 10  # per hour
    restart: 10  # per hour
    terminate: 2  # per hour
  by_user:
    service_account: 10000  # per hour (for automation)
    human_user: 1000  # per hour
